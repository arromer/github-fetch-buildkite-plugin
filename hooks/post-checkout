#!/usr/bin/env bash

set -euo pipefail

get_changed_attr_file() {
    git diff --name-only "$( git merge-base master HEAD )" | grep .gitattributes
}

check_lfs_integrity_at() {
    files="$( git ls-files $1 )"

    while read -r f; do
        local err
        err=false

        if [[ -n "$( git check-attr filter $f | grep "filter: lfs" )" ]]; then
            git cat-file blob "HEAD:$f" 2>1 | git lfs pointer --stdin --file=$f 2>1 > /dev/null || { err=true; false; }
        fi

        if [[ ${err} == true ]]; then
            echo $f
        fi
    done<<< "${files}"
    set -e
}

main() {
    if [[ ${BUILDKITE_PLUGIN_GITHUB_CHECK_LFS_INTEGRITY:-true} == true ]]; then
        local TARGET_PATH="${1:-'.'}"

        cd "${TARGET_PATH}"
        local attr_files="$(get_changed_attr_file)"

        while read -r attr_file; do
            local attr_file_path="$(dirname ${attr_file})"
            local rtn=$(check_lfs_integrity_at "${attr_file_path}")
            if [[ -n "${rtn}" ]]; then 
                while read -r broken_file; do
                    echo "${broken_file}"
                done<<< "${rtn}"

                exit 117
            fi
        done<<< "${attr_files}"
    fi    
}

main "$@"
