#!/usr/bin/env bash

set -euo pipefail

# URL for access to the repository
GIT_REPO="${BUILDKITE_PLUGIN_GITHUB_FETCH_URL_INSTEADOF:-${BUILDKITE_REPO}}"

# Checks if an env var is set
# Arguments:
# $1: var name
check_set() {
  local name="$1"
  if [[ -z "${!name:-}" ]]; then
    echo "ERROR: ${name} not set"
    exit 1
  fi
}

main() {
  check_set BUILDKITE_REPO

  if [[ "$(git rev-parse --is-inside-work-tree 2>/dev/null)" == "true" ]]; then
    # set git repo but keep the LFS URL
    echo "setting repo origin to ${GIT_REPO}"
    git remote set-url origin "${GIT_REPO}"

    echo "setting LFS URL to ${BUILDKITE_REPO}"
    git config lfs.url "${BUILDKITE_REPO}"
  fi
}

main "$@"
